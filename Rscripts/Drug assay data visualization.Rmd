---
title: "Drug assay data visualization"
output: html_notebook
---

Here we want to visualize how the data is distributed across the patients on each feature for every dose so that we can see how relevant it is to take into account all the data points that we have. We want to conclude on relevant model to fit and a relevant scale transformation to apply.

## Paths

Here we set all the necessary paths to import and save data and plots.

```{r}
current_dir <- getwd()
my_path <- sub("/[^/]+$", "", current_dir)
setwd(paste0(my_path,"/Rscripts"))
OOL_path=paste0(my_path,"/Onset of Labor data")
drug_assay_path=paste0(my_path,"/Drug assay data")
out_path=paste0(drug_assay_path,"/Preprocessed Data")
plot_path=paste0(my_path,"/Plots/Drug Assay data visualization")
```

Creation of a new directory for the outputs.

```{r}
if(!file.exists(out_path)){dir.create(out_path, recursive = TRUE)}
if(!file.exists(plot_path)){dir.create(plot_path, recursive = TRUE)}
```

## Libraries

```{r}
library(tidyverse)
library(tidyselect)
library(reshape2)
library(dplyr)
library(viridis)
library(tidyr)
library(janitor)
library(utils)
library(ggplot2)
library(gridExtra)
library(grid)
```

## Importing and restructuring data

Importing preprocessed penalized data

```{r}
pen_final_data <- read.csv(paste0(drug_assay_path, "/Preprocessed Data/preprocessed_pen.csv")) %>%
                  # Removing the asinh transform of unstim_0
                  filter(dose >= 0)
```

```{r}
AllPenDoseresponse <- pen_final_data %>%
    # Adding a D in front of the dose value
    mutate(dose = paste0("D", dose)) %>%
    dcast(ID + population + reagent + drug + stimulation ~ dose, value.var = "feature") %>%
    # feature = population_reagent_stimulation
    mutate(feature=paste0(population, "_", reagent, "_", stimulation)) %>% 
    pivot_longer(cols = c("D0", "D1", "D10", "D100", "D1000")) %>%
    rename("dose" = "name") %>%
    select(c("ID", "feature", "drug", "dose", "value")) %>%
    na.omit()

head(AllPenDoseresponse)
```

```{r}
save(AllPenDoseresponse, file=paste0(out_path, "/all pen dose response.rda"))
```

## Visualizing data distributions

Here we visualize the data for each dose individually.

```{r}
# Function that create a grid with the plots of boxplots of the features for every drug for a specific target dose
# The point of this plot is to see if the values of the features are significantly similar enough to justify the construction of a model

top_n_var_features_boxplot_grid <-function(target_dose, n){
  # Subset the data for dose=="D0"
  subset_data <- AllPenDoseresponse %>% dplyr::filter(dose == target_dose)
  
  # Create an empty list to store the boxplot plots
  boxplot_plots <- list()
  
  # Iterate over each drug
  for (target_drug in unique(subset_data$drug)) {
    # Subset the data for the current drug
    drug_data <- subset_data %>% dplyr::filter(drug == target_drug)
    
    # Compute the variance for each feature
    variances <- drug_data %>%
                  group_by(feature) %>%
                  summarize(variance = var(value)) %>%
                  arrange(desc(variance))
    
    # Select the top n features with the biggest variances
    top_features <- head(variances$feature, n)
    
    # Subset the data for the top features
    top_data <- drug_data %>% 
                  dplyr::filter(feature %in% top_features) %>%
                  dplyr::mutate(ID = as.factor(ID)) 
    
    ordered_features <- top_data %>%
                          group_by(feature) %>%
                          summarize(median_value = median(value, na.rm = TRUE)) %>%
                          arrange(desc(median_value)) %>%
                          pull(feature)
  
    # Convert feature to factor with the desired order
    top_data$feature <- factor(top_data$feature, levels = ordered_features)
    
    # Create a boxplot plot for the current drug
    p <- ggplot(top_data, mapping = aes(x = feature, y = value)) +
      geom_boxplot() +
      geom_point(na.rm = T, alpha = 0.5, aes(color = ID)) +
      labs(title = target_drug) +
      theme(plot.title = element_text(size = 12, margin = margin(r = 5)),
            axis.text.x = element_text(size = 4, angle = 30),
            axis.title.x = element_blank(),
            axis.title.y = element_blank())
    
    # Store the boxplot plot in the list
    boxplot_plots[[target_drug]] <- p
  }
  
  # Save the grid of boxplots as a PDF file
  pdf(paste(plot_path, "/", target_dose, "_top", n, "variances_feature_boxplot_grid.pdf", sep=""), 
      width = 15, height = 8)
  for (i in 0:4){
    grid.draw(grid.arrange(grobs=boxplot_plots[(3*i+1):(3*i+3)], nrow=3, ncol = 1))
  }
  dev.off()
}
```

```{r}
###### WARNING THIS CELL TAKES 15-20min TO RUN ! ###### 

target_doses <- c("D0", "D1", "D10", "D100", "D1000")
n <- 100

for (target_dose in target_doses){
  top_n_var_features_boxplot_grid(target_dose, n)
}
```

Here we visualize the data for each features individually.

```{r}
# Function creating one plot
plot_feature_drug_boxplot <- function(target_feature, target_drug){
  subset <- AllPenDoseresponse %>%
              dplyr::filter(feature == target_feature,
                            drug == target_drug) %>%
              dplyr::mutate(ID = as.factor(ID))
  p <- ggplot(subset, mapping = aes(x = dose, y = value)) +
      geom_boxplot() +
      geom_point(na.rm = T, alpha = 0.5, aes(color = ID)) +
      geom_line(aes(group = ID, color = ID), linewidth=1.5) +
      xlab(target_drug) +
      ylab(target_feature)
  return(p)
}
```

Plotting all the data

```{r}
###### WARNING THIS CELL TAKES MORE THAN 1 HOUR TO RUN ! ######

# Creating a list containing all the plots
list_plots <- list()
for (target_feature in unique(AllPenDoseresponse$feature)){
  for (target_drug in unique(AllPenDoseresponse$drug)){
    list_plots[[length(list_plots)+1]] <- plot_feature_drug_boxplot(target_feature, target_drug)
  }
}
# Save the grid of boxplots as a PDF file
pdf(paste0(plot_path, "/Drug_feature_boxplot_grid.pdf"), width = 15, height = 9)
for (i in 0:(length(unique(AllPenDoseresponse$feature))-1)){
  grid.draw(grid.arrange(grobs=list_plots[(15*i+1):(15*i+15)], nrow=3, ncol = 5))
}
dev.off()
```

Plotting all the features selected by the OOL model

```{r}
# feature.index
load(paste0(OOL_path, "/Prediction model/feature_index.rda"))
# features with positive model_index (selected by the model)
feature_list <- subset(feature.index, model_index > 0, select=feature)$feature
# Creating a list containing all the plots
list_plots <- list()
for (target_feature in feature_list){
  for (target_drug in unique(AllPenDoseresponse$drug)){
    list_plots[[length(list_plots)+1]] <- plot_feature_drug_boxplot(target_feature, target_drug)
  }
}
# Save the grid of boxplots as a PDF file
pdf(paste0(plot_path, "/Drug_selected_feature_boxplot_grid.pdf"), width = 15, height = 9)
for (i in 0:(length(feature_list)-1)){
  grid.draw(grid.arrange(grobs=list_plots[(15*i+1):(15*i+15)], nrow=3, ncol = 5))
}
dev.off()
```
**Note :** The visualization of the data helped us see that the trend of the medians was interesting to look at as well as the individual trends. It also helped us decide to transform the scale of the concentrations as shown below.

## Scale transforms

Here we transform the doses into actual values (0, 1, 10, 100, 1000) and then we transform these values on different scales that we are going to try building sigmoids functions on.

```{r}
AllPenDoseresponse <- AllPenDoseresponse %>%
                        dplyr::mutate(dose = as.numeric(sub("^D", "", dose)),
                                      # Log10 transform (0 are set to NA)
                                      log10_dose = log10(dose),
                                      # Log10(x + 1) transform
                                      log10_1_dose = log10(dose +1),
                                      # Pseudo log transform
                                      pseudo_log_dose = asinh(dose/2)/log(10))

MedianDoseresponse <- AllPenDoseresponse %>%
                        group_by(dose, drug, feature) %>%
                        dplyr::mutate(median_value = median(value, na.rm = TRUE)) %>%
                        dplyr::select(-c(ID, value)) %>%
                        distinct()
```

Saving the datasets with all the scales

```{r}
save(AllPenDoseresponse, file=paste0(out_path, "/all pen dose response with scales.rda"))
save(MedianDoseresponse, file=paste0(out_path, "/median pen dose response with scales.rda"))
```


