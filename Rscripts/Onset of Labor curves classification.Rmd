---
title: "Onset of Labor curves classification"
output: html_notebook
---

This is script has been partially taken from the original OOL Study and modified to retrieve results of interests to the drug assay study : the behavior/ trend of the features in normal pregnancy.

## Paths

Here we set all the necessary paths to import and save data and plots.

```{r}
current_dir <- getwd()
my_path <- sub("/[^/]+$", "", current_dir)
setwd(paste0(my_path,"/Rscripts"))
OOL_path=paste0(my_path,"/Onset of Labor data")
funct_path=paste0(OOL_path,"/Preprocessed Data/immunome_EGA_DOS_pen_OOL.csv")
out_path=paste0(OOL_path,"/Curve classification")
plot_path=paste0(my_path, "/Plots/Onset of Labor curve classification")
```

Creating directories for the outputs

```{r}
if(!file.exists(out_path)){dir.create(out_path, recursive = TRUE)}
if(!file.exists(plot_path)){dir.create(plot_path, recursive = TRUE)}
```

## Libraries

```{r}
library(tidyverse)
library(sjstats)
library(broom)
library(gridExtra)
```

## Script settings

Selecting if you want the following script to fit functions of DOS or EGA and if you want to fit on term, preterm or all the data.

```{r}
mode <- "EGA" #EGA or DOS
cohort <- "all" #preterm or term or all
```

## Curves classification

Importing the data

```{r}
# Onset of Labor data
data <- read.csv(funct_path)
preterm_ID <- c("P17_","P8_","P3_","P5_","P27_")

# Removing the datapoints that are post partum and filtering all, preterm or term patients
if (cohort=="all"){
  data <- data %>% dplyr::filter(DOS <= 0)
}
if (cohort=="preterm"){
  data <- data %>% dplyr::filter(DOS <= 0)
  data <- data[apply(data, 1, function(row) any(grepl(paste(preterm_ID, collapse = "|"), row["ID"]))), ]
}
if (cohort=="term"){
  data <- data %>% dplyr::filter(DOS <= 0)
  data <- data[!apply(data, 1, function(row) any(grepl(paste(preterm_ID, collapse = "|"), row["ID"]))), ]
}

# Timepoints
DOS = data$DOS
EGA = data$EGA

# Timepoints squared
data$DOS2 = DOS^2
data$EGA2 = EGA^2

# Names of the immunome features
cytof <- setdiff(colnames(data), c("DOS", "DOS2", "EGA", "EGA2", "ID"))
```

**df_models :** dataframe containing the list of the immunome features with the best fitted model (either linear or quadratic).

**df_sum :** dataframe containing the list of the immunome features and information regarding the linear and quadratic models:
- coefficients of the quadratic model (a, b)
- pvalue of the best model
- the AIC of linear and quadratic models
- the class of the best model (linear or quadratic)
- the pattern of the best model (accelerating/decelrating and increasing/decreasing)

```{r}
# Initializing variables
cv_lin = c()
best = c()
cv_both = c()
coef_lin = c()
coef_quad_d1 = c()
coef_quad_d2 = c()
class = c()
df_models <- data.frame(feature = character(),
                        best.model = I(list()),
                        stringsAsFactors = FALSE)

# Building linear and quadratic models
for (feature in cytof){
  # Subset of the data
  data$p1 = unlist(data[feature])
  # Linear fitting
  if (mode=="DOS"){fit_lin <- lm(p1 ~ DOS, data)}
  if (mode=="EGA"){fit_lin <- lm(p1 ~ EGA, data)}
  # Adding linear coefficients to coef_lin
  coef_lin = append(coef_lin,fit_lin$coefficients[2])
  # Adding the AIC of the linear model to cv_lin
  cv_lin = append(cv_lin, AIC(fit_lin))
  
  # Quadratic fitting
  if (mode=="DOS"){fit_both <- lm(p1 ~ DOS + DOS2, data)}
  if (mode=="EGA"){fit_both <- lm(p1 ~ EGA + EGA2, data)}
  # Adding the AIC of the quadratic model to cv_both
  cv_both = append(cv_both, AIC(fit_both))
  # Adding the coefficient of DOS to coef_quad_d1
  coef_quad_d1 = append(coef_quad_d1,fit_both$coefficients[2])
  # Adding the coefficient of DOS^2 to coef_quad_d1
  coef_quad_d2 = append(coef_quad_d2,fit_both$coefficients[3])
  
  # Adding the pvalue of the best model to best according to their AIC
  best = append(best, ifelse(AIC(fit_both)<AIC(fit_lin), 
                             glance(fit_both)$p.value, glance(fit_lin)$p.value))
  # Adding the class of the best model to class according to their AIC
  class = append(class, ifelse(AIC(fit_both)<AIC(fit_lin), 
                             "quadratic", "linear"))
  
  # Adding the best model to df_models according to AIC 
  best.model = ifelse(AIC(fit_both)<AIC(fit_lin), 
                      fit_both, fit_lin)
  df_models <- rbind(df_models, 
                      data.frame(feature = feature,
                                  model = I(list(best.model)), 
                                  stringsAsFactors = FALSE))
}

# Creating df_sum with all the collected information on the models
df_sum = data.frame(cytof, 
                    linear_aic = cv_lin,
                    quadratic_aic = cv_both, 
                    pval = best, 
                    a = coef_quad_d2, 
                    b = coef_quad_d1,
                    class = class)

# Determining the pattern of a feature based on the coefficient of the quadratic model
pattern = c()
for (i in 1:length(df_sum$class)){
  if (class[i] == 'linear'){
    pattern = append(pattern, 'linear')
  } else {
    if (coef_quad_d2[i]>0){
      if ((coef_quad_d1[i]+2*coef_quad_d2[i]*(-50))>0){
        pattern = append(pattern, 'acceleration/increase')
      } else {
        pattern = append(pattern, 'deceleration/decrease')
      }
      
    } else {
      if ((coef_quad_d1[i]+2*coef_quad_d2[i]*(-50))>0){
        pattern = append(pattern, 'deceleration/increase')
      } else {
        pattern = append(pattern, 'acceleration/decrease')
      }
      } 
  }
}
df_sum$pattern = pattern
```

Saving df_sum and df_models.

```{r}
if (mode=="DOS"){
  write.csv(df_sum, paste(out_path, "/",cohort,"_pen_classification_curves_cytof.csv", sep=""))
  save(df_models, file=paste(out_path, "/",cohort,"_pen_model_curves_cytof.rda", sep=""))
}
if (mode=="EGA"){
  write.csv(df_sum, paste(out_path, "/",cohort,"_pen_classification_curves_cytof_on_EGA.csv", sep=""))
  save(df_models, file=paste(out_path, "/",cohort,"_pen_model_curves_cytof_on_EGA.rda", sep=""))
}
```

## Visualization

We are plotting the best features according to the OOL paper

```{r}
feature_list <- c("CD56loCD16posNK_STAT1_IFNa",
                  # Granulocytes frequency is not in our study
                  "CD56hiCD16negNK_STAT1_IFNa",
                  "CD4Tnaive_MAPKAPK2_IFNa",
                  "ncMCs_CREB_GMCSF",
                  "CD8Tcm_MAPKAPK2_unstim", 
                  "CD8Tem_MAPKAPK2_unstim",
                  "pDCs_STAT1_IFNa",
                  "Bcells_MAPKAPK2_LPS",
                  "CD4Tem_MAPKAPK2_unstim",
                  "CD8Tcm_MAPKAPK2_IFNa", 
                  "CD8Tem_MAPKAPK2_IFNa",
                  # Bcells freq is not in our study
                  "CD4Tem_NFkB_IL246",
                  "CD4Tcm_IkB_unstim",
                  "mDCs_STAT6_IFNa", 
                  "pDCs_STAT6_IFNa",
                  "mDCs_MAPKAPK2_unstim", 
                  "pDCs_MAPKAPK2_unstim")
```

Plot (you can look at this plot in your folder /Plots/Onset of Labor curve classification)

```{r}
if (mode=="DOS"){
  x=DOS
}
if (mode=="EGA"){
  x=EGA
}
plots <- list()
for (target_feature in feature_list) {
  # Getting the coefficients and class of the model
  coefs <- df_models[df_models$feature == target_feature,]$model[[1]][[1]]
  
  # Building the predictions
  y <- data[, target_feature]
  intercept <- coefs[['(Intercept)']]
  if (length(coefs) == 3){ # quadratic model
    a <- coefs[[paste0(mode,2)]]
    b <- coefs[[mode]]
    y_pred <- intercept + b * x + a * x^2
  }
  else{ # length(coefs) == 2, linear model
    slope <- coefs[[mode]]
    y_pred <- intercept + slope * x
  }
  
  df <- data.frame(x = x, y = y, y_pred = y_pred)
  pval <- df_sum[df_sum$cytof == target_feature,]$pval
    
  # Plot
  plot <- ggplot(df, aes(x = x, y = y)) +
      geom_point(fill = "white", shape=1, color="grey", size = 0.8, na.rm = TRUE) +
      geom_line(aes(y = y_pred), color = "darkgreen") +
      ggtitle(paste(target_feature, pval, sep=",\np = ")) +
      ylab("Arcsinh ratio\nover unstim signal") +
      xlab(mode) +
      theme(plot.title = element_text(size = 6),
            panel.background = element_rect(fill = NA, color = NA),
            plot.background = element_rect(fill = NA, color = NA),
            axis.title.x = element_text(size = 5),
            axis.title.y = element_text(size = 5),
            axis.text.x = element_text(size = 5),
            axis.text.y = element_text(size = 5),
            axis.line.x = element_line(),
            axis.line.y = element_line())
    
  plots[[target_feature]] <- plot
}

# Saving the plots
pdf(paste(plot_path, "/best_features_plot_on_",mode,"_OOL.pdf", sep=""))
for (i in 0:floor(length(plots)/16)){
  grid.arrange(grobs = plots[(16*i+1):min(length(plots),(16*i+16))], nrow = 4, ncol = 4)
}
dev.off()
```

**The following plots requires that you've already run "Onset of Labor feature index and patient clustering.Rmd"**

Plotting term and preterm features as functions of EGA on the same figures (you can look at this plot in your folder /Plots/Onset of Labor curve classification).

```{r}
# Variable settings
preterm_ID <- c("P17_","P8_","P3_","P5_","P27_")
mode="EGA"

# Importing OOL data
data <- read.csv(funct_path) %>% filter(DOS <= 0)
# EGA
EGA=data$EGA
# feature.index
load(paste0(OOL_path, "/Prediction model/feature_index.rda"))
# Selecting the features with index > 0
feature_list <- feature.index[feature.index$model_index > 0, "feature"]

# Preterm data, models and summary
load(paste0(out_path, "/preterm_pen_model_curves_cytof_on_EGA.rda"))
df_preterm_models=df_models
df_preterm_sum=read.csv(file=paste0(out_path,"/preterm_pen_classification_curves_cytof_on_EGA.csv"))
preterm_data=data[apply(data, 1, function(row) any(grepl(paste(preterm_ID, collapse = "|"), row["ID"]))), ]
preterm_EGA=preterm_data$EGA

# Term data, models and summary
load(paste0(out_path, "/term_pen_model_curves_cytof_on_EGA.rda"))
df_term_models=df_models
df_term_sum=read.csv(file=paste0(out_path,"/term_pen_classification_curves_cytof_on_EGA.csv"))
term_data=data[!apply(data, 1, function(row) any(grepl(paste(preterm_ID, collapse = "|"), row["ID"]))), ]
term_EGA=term_data$EGA

# Plots
plots <- list()
for (target_feature in feature_list) {
  # PRETERM
  coefs <- df_preterm_models[df_preterm_models$feature == target_feature,]$model[[1]][[1]]
  # building the predictions
  y_preterm <- preterm_data[, target_feature]
  intercept <- coefs[['(Intercept)']]
  if (length(coefs) == 3){ # quadratic model
    a <- coefs[[paste0(mode,2)]]
    b <- coefs[[mode]]
    y_pred_preterm <- intercept + b * EGA + a * EGA^2
  }
  else{ # length(coefs) == 2, linear model
    slope <- coefs[[mode]]
    y_pred_preterm <- intercept + slope * EGA
  }
  
  # TERM
  coefs <- df_term_models[df_term_models$feature == target_feature,]$model[[1]][[1]]
  # building the predictions
  y_term <- term_data[, target_feature]
  intercept <- coefs[['(Intercept)']]
  if (length(coefs) == 3){ # quadratic model
    a <- coefs[[paste0(mode,2)]]
    b <- coefs[[mode]]
    y_pred_term <- intercept + b * EGA + a * EGA^2
  }
  else{ # length(coefs) == 2, linear model
    slope <- coefs[[mode]]
    y_pred_term <- intercept + slope * EGA
  }
  
  df_preds <- data.frame(x = EGA, y_pred_preterm = y_pred_preterm, y_pred_term = y_pred_term)
  df_preterm_points <- data.frame(x = preterm_EGA, y = y_preterm)
  df_term_points <- data.frame(x = term_EGA, y = y_term)
  pval_preterm <- df_preterm_sum[df_preterm_sum$cytof == target_feature,]$pval
  pval_term <- df_preterm_sum[df_preterm_sum$cytof == target_feature,]$pval
  
  # Plot
  plot <- ggplot() +
      geom_point(data=df_term_points, aes(x = x, y = y), fill="white", shape=1, color = "grey", size = 1., na.rm = TRUE) +
      geom_line(data=df_preds, aes(x = x, y = y_pred_term), color = "darkgreen") +
      geom_point(data=df_preterm_points, aes(x = x, y = y), fill="white", shape=1, color = "blue", size = 1., na.rm = TRUE) +
      geom_line(data=df_preds, aes(x = x, y = y_pred_preterm), color = "blue") +
      theme(plot.title = element_text(size = 6),
            panel.background = element_rect(fill = NA, color = NA),
            plot.background = element_rect(fill = NA, color = NA),
            axis.title.x = element_text(size = 6),
            axis.title.y = element_text(size = 6),
            axis.text.x = element_text(size = 6),
            axis.text.y = element_text(size = 6),
            axis.line.x = element_line(),
            axis.line.y = element_line()) +
      ggtitle(paste(target_feature, "\n (green) term p-value = ",pval_term,"\n (blue) term p-value = ",pval_preterm, sep="")) +
      ylab("Arcsinh ratio\nover unstim signal") +
      xlab(mode)

  plots[[target_feature]] <- plot
}

# Saving the plots
pdf(paste(plot_path, "/best_features_plot_on_",mode,"_term_vs_preterm_OOL.pdf", sep=""), height=8, width=9)
for (i in 0:floor(length(plots)/16)){
  grid.arrange(grobs = plots[(16*i+1):min(length(plots),(16*i+16))], nrow = 4, ncol = 4)
}
dev.off()
```

Plotting term and preterm features as functions of EGA on the same figures with the assumption that term and preterm functions should be the same with a time delay (you can look at this plot in your folder /Plots/Onset of Labor curve classification).

```{r}
# Variable settings
preterm_ID <- c("P17_","P8_","P3_","P5_","P27_")
mode="EGA"

# Importing OOL data
data <- read.csv(funct_path) %>% filter(DOS <= 0)
# EGA
EGA=data$EGA
# feature.index
load(paste0(OOL_path, "/Prediction model/feature_index.rda"))
# Selecting the features with index > 0
feature_list <- feature.index[feature.index$model_index > 0, "feature"]

# Preterm data
preterm_data=data[apply(data, 1, function(row) any(grepl(paste(preterm_ID, collapse = "|"), row["ID"]))), ]
preterm_EGA=preterm_data$EGA

# Term data, models and summary
load(paste0(out_path, "/term_pen_model_curves_cytof_on_EGA.rda"))
df_term_models=df_models
df_term_sum=read.csv(file=paste0(out_path,"/term_pen_classification_curves_cytof_on_EGA.csv"))
term_data=data[!apply(data, 1, function(row) any(grepl(paste(preterm_ID, collapse = "|"), row["ID"]))), ]
term_EGA=term_data$EGA

# Function to calculate the sum of squared residuals for linear or quadratic functions
sum_squared_residuals <- function(translation, class, coefficients, x, y) {
  if (class=="quadratic"){
    a <- coefficients[1]
    b <- coefficients[2]
    c <- coefficients[3]
    residuals <- (a * (x-translation)^2 + b * (x-translation) + c) - y
    return(sum(residuals^2))
  }else if (class=="linear"){
    a <- coefficients[1]
    b <- coefficients[2]
    residuals <- (a * (x-translation) + b) - y
    return(sum(residuals^2))
  }else{
    return(NULL)
  }
}

# Plots
plots <- list()
for (target_feature in feature_list) {
  # PRETERM
  # Building the model which is going to fit best preterm data according to 
  coefs <- df_term_models[df_term_models$feature == target_feature,]$model[[1]][[1]]
  # Building the predictions
  y_preterm <- preterm_data[, target_feature]
  intercept <- coefs[['(Intercept)']]
  if (length(coefs) == 3){ # quadratic model
    # Coefficient from term
    a <- coefs[[paste0(mode,2)]]
    b <- coefs[[mode]]
    # Find the best translation factor
    best_translation <- suppressWarnings(optim(0, sum_squared_residuals, class = "quadratic", coefficients = c(a, b, intercept), x = preterm_EGA, y = y_preterm))
    delay <- best_translation$par
    # Building the preterm predictions 
    y_pred_preterm <- intercept + b * (EGA-delay) + a * (EGA-delay)^2
  }
  else{ # length(coefs) == 2, linear model
    # Coefficient from term
    slope <- coefs[[mode]]
    # Find the best translation factor
    best_translation <- suppressWarnings(optim(0, sum_squared_residuals, class = "linear", coefficients = c(slope, intercept), x = preterm_EGA, y = y_preterm))
    delay <- best_translation$par
    # Building the preterm predictions 
    y_pred_preterm <- intercept + slope * (EGA-delay)
  }
  
  # TERM
  coefs <- df_term_models[df_term_models$feature == target_feature,]$model[[1]][[1]]
  # building the predictions
  y_term <- term_data[, target_feature]
  intercept <- coefs[['(Intercept)']]
  if (length(coefs) == 3){ # quadratic model
    a <- coefs[[paste0(mode,2)]]
    b <- coefs[[mode]]
    y_pred_term <- intercept + b * EGA + a * EGA^2
  }
  else{ # length(coefs) == 2, linear model
    slope <- coefs[[mode]]
    y_pred_term <- intercept + slope * EGA
  }
  
  df_preds <- data.frame(x = EGA, y_pred_preterm = y_pred_preterm, y_pred_term = y_pred_term)
  df_preterm_points <- data.frame(x = preterm_EGA, y = y_preterm)
  df_term_points <- data.frame(x = term_EGA, y = y_term)
  pval_preterm <- df_preterm_sum[df_preterm_sum$cytof == target_feature,]$pval
  pval_term <- df_preterm_sum[df_preterm_sum$cytof == target_feature,]$pval
  
  # Plot
  plot <- ggplot() +
      geom_point(data=df_term_points, aes(x = x, y = y), fill="white", shape=1, color = "grey", size = 1., na.rm = TRUE) +
      geom_line(data=df_preds, aes(x = x, y = y_pred_term), color = "darkgreen") +
      geom_point(data=df_preterm_points, aes(x = x, y = y), fill="white", shape=1, color = "blue", size = 1., na.rm = TRUE) +
      geom_line(data=df_preds, aes(x = x, y = y_pred_preterm), color = "blue") +
      theme(plot.title = element_text(size = 6),
            panel.background = element_rect(fill = NA, color = NA),
            plot.background = element_rect(fill = NA, color = NA),
            axis.title.x = element_text(size = 6),
            axis.title.y = element_text(size = 6),
            axis.text.x = element_text(size = 6),
            axis.text.y = element_text(size = 6),
            axis.line.x = element_line(),
            axis.line.y = element_line()) +
      ggtitle(paste(target_feature, "\n (green) term p-value = ",pval_term,"\n (blue) term p-value = ",pval_preterm, sep="")) +
      ylab("Arcsinh ratio\nover unstim signal") +
      xlab(mode)

  plots[[target_feature]] <- plot
}

# Saving the plots
pdf(paste(plot_path, "/best_features_plot_on_",mode,"_term_vs_preterm_with_assumption_OOL.pdf", sep=""), height=8, width=9)
for (i in 0:floor(length(plots)/16)){
  grid.arrange(grobs = plots[(16*i+1):min(length(plots),(16*i+16))], nrow = 4, ncol = 4)
}
dev.off()
```